{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceNamePrefix": {
            "type": "string",
            "defaultValue": "ngfwv",
            "minLength" : 3,
            "maxLength" : 10,
            "metadata": {
                "description": "Prefix used in resource names created by this template(Use only lowercase letters)"
            }
        },
        "virtualNetworkRg": {
            "type": "string",
            "defaultValue": "cisco-virtualnet-rg",
            "metadata": {
                "description": "Virtual network resource group name"
            }
        },
        "virtualNetworkName": {
            "type": "string",
            "defaultValue": "cisco-virtualnet",
            "metadata": {
                "description": "Virtual network name"
            }
        },
        "virtualNetworkCidr": {
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description": "CIDR of virtual network"
            }
        },
        "mgmtSubnet": {
            "type": "string",
            "defaultValue": "mgmt",
            "metadata": {
                "description": "Management subnet name"
            }
        },
        "diagSubnet": {
            "type": "string",
            "defaultValue": "diag",
            "metadata": {
                "description": "Diagnostic subnet name"
            }
        },
        "insideSubnet": {
            "type": "string",
            "defaultValue": "inside",
            "metadata": {
                "description": "Inside subnet name."
            }
        },
        "insideNetworkGatewayIp": {
            "type": "string",
            "defaultValue": "10.0.3.1",
            "metadata": {
                "description": "Inside Subnet Gateway IP"
            }
        },
        "internalLbIP": {
            "type": "string",
            "defaultValue": "10.0.3.4",
            "metadata": {
                "description": "Internal LB IP in inside subnet."
            }
        },
        "outsideSubnet": {
            "type": "string",
            "defaultValue": "outside",
            "metadata": {
                "description": "Outside subnet name"
            }
        },
        "outsideNetworkGatewayIp": {
            "type": "string",
            "defaultValue": "10.0.4.1",
            "metadata": {
                "description": "Outside Subnet Gateway IP"
            }
        },
        "cclSubnet": {
            "type": "string",
            "defaultValue": "ccl",
            "metadata": {
                "description": "Outside subnet name"
            }
        },
        "cclSubnetStartAddr": {
            "type": "string",
            "defaultValue": "10.0.5.4",
            "metadata": {
                "description": "Start Address of the CCL Subnet"
            }
         },
         "cclSubnetEndAddr": {
            "type": "string",
            "defaultValue": "10.0.5.253",
            "metadata": {
                "description": "End Address of the CCL Subnet"
            }
         },
        "clusterGroupName": {
            "type": "string",
            "defaultValue": "ngfwv-cluster",
            "metadata": {
                "description": "Cluster Group Name"
            }
        },
        "imageId": {
            "type": "string",
            "defaultValue": "/subscriptions/f160cf7e-ae69-4e9f-8ad0-b434b9a63755/resourceGroups/blr-virtual-images-rg/providers/Microsoft.Compute/galleries/virtBlrImgGallery/images/ftdv/versions/2.376.730108901",
            "metadata": {
                "description": "FTDv image resource ID."
            }
        },
        "vmSize": {
            "type" : "string",
            "defaultValue" : "Standard_D4_v2",
            "allowedValues" : [
                "Standard_D4_v2",
                "Standard_D5_v2"
            ],
            "metadata" : {
                "description" : "Size of the Virtual Machine"
            }
        },
        "ftdLicensingSku": {
            "type" : "string",
            "defaultValue" : "ftdv-azure-payg",
            "allowedValues" : [
                "ftdv-azure-byol",
                "ftdv-azure-payg"
            ],
            "metadata" : {
                "description" : "Licensing model (ftdv-azure-byol : Bring-your-own-license, ftdv-azure-payg : Pay-as-you-go)"
            }
        },
        "ftdVmManagementUserName": {
            "type": "string",
            "defaultValue": "cisco",
            "metadata": {
                "description": "Username for primary account on the virtual machine (used only for vm management). This is not the admin username and 'admin' is reserved."
            }
        },
        "ftdVmManagementUserPassword": {
            "type": "securestring",
            "defaultValue" : "",
            "metadata": {
                "description": "Password for the FTD VM management user (Passwords must be 12 to 72 characters long, must have : lowercase, uppercase, numbers & special characters and must have no more than 2 repeating characters)"
            }
        },
        "ftdAdminUserPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "Password for FTD 'admin' user (Passwords must be 12 to 72 characters long, must have : lowercase, uppercase, numbers & special characters and must have no more than 2 repeating characters)"
            }
        },
        "fmcIpAddress": {
            "type": "string",
            "defaultValue": "1.2.3.4",
            "metadata": {
                "description": "FMC Public IP Address"
            }
        },
        "fmcUserName": {
            "type": "string",
            "defaultValue": "fmcUser",
            "metadata": {
                "description": "FMC User name"
            }
        },
        "fmcPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "FMC Password"
            }
        },
        "insideZoneName": {
            "type": "string",
            "defaultValue": "inside-sz",
            "metadata": {
                "description": "Inside Zone Name"
            }
        },
        "outsideZoneName": {
            "type": "string",
            "defaultValue": "outside-sz",
            "metadata": {
                "description": "Outside Zone Name"
            }
        },
        "policyName": {
            "type": "string",
            "defaultValue": "myPolicy",
            "metadata": {
                "description": "Security Policy Name created in FMC"
            }
        },
        "licenseCapability": {
            "type": "string",
            "defaultValue": "BASE,MALWARE,THREAT",
            "metadata": {
                "description": "Comma separated License Capability list (Valid values : BASE, MALWARE, URLFilter, THREAT)"
            }
        },
        "ftdvClusterNodeCount": {
            "type": "string",
            "defaultValue": "4",
            "metadata": {
                "description": "Number of NGFWs in Scale Set"
            }
        }
    },
    "variables": {
        "vmssName":             "[concat(parameters('resourceNamePrefix'),'-vmss')]",
        "elbName":             "[concat(parameters('resourceNamePrefix'),'-elb')]",
        "ilbName":             "[concat(parameters('resourceNamePrefix'),'-ilb')]",
        "dataSecGrp":           "[concat(parameters('resourceNamePrefix'),'-dataIntfSecGrp')]",
        "mgmtSecGrp":           "[concat(parameters('resourceNamePrefix'),'-mgmtIntfSecGrp')]",
    	"functionAppName":      "[concat(parameters('resourceNamePrefix'),'-function-app')]",
    	"appInsightsName":      "[concat(parameters('resourceNamePrefix'),'-appinsight')]",
        "elbPublicIpName":      "[concat(variables('elbName'),'-public-ip')]",
        "elbId":                "[resourceId('Microsoft.Network/loadBalancers',variables('elbName'))]",
        "ilbId":                "[resourceId('Microsoft.Network/loadBalancers',variables('ilbName'))]",
        "vnetId":                "[resourceId(parameters('virtualNetworkRg'),'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
        "mgmtSubnetId":          "[concat(variables('vnetID'),'/subnets/', parameters('mgmtSubnet'))]",
        "diagSubnetId":          "[concat(variables('vnetID'),'/subnets/', parameters('diagSubnet'))]",
        "insideSubnetId":        "[concat(variables('vnetID'),'/subnets/', parameters('insideSubnet'))]",
        "outsideSubnetId":       "[concat(variables('vnetID'),'/subnets/', parameters('outsideSubnet'))]",
        "cclSubnetId":           "[concat(variables('vnetID'),'/subnets/', parameters('cclSubnet'))]",
        "storageAccountName":    "[concat(parameters('resourceNamePrefix'), uniquestring(resourceGroup().id))]",
        "storageAccountid":      "[concat(resourceGroup().id,'/providers/','Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
        "functionAppId":         "[concat(resourceGroup().id,'/providers/','Microsoft.Web/sites/', variables('functionAppName'))]",
        "functionWorkerRuntime": "python",
        "vmssVmMgmtNicName":     "mgmtNic",
        "vmssVmDiagNicName":     "diagNic",
        "vmssVmInsideNicName":   "insideNic",
        "vmssVmOutsideNicName":  "outsideNic",
        "vmssVmCclNicName":      "cclNic",
        "idleTimeoutInMinutes":  30,
        "publisher":             "cisco",
        "offer":                 "cisco-ftdv",
        "sku":                   "[parameters('ftdLicensingSku')]",
        "systopicname":          "[concat(parameters('resourceNamePrefix'),'-systopic')]",
        "queuename":             "resourceactionsuccessqueue",
        "esubname":              "[concat(parameters('resourceNamePrefix'),'-esub')]",
        "role1":                 "[guid(resourceGroup().id,subscription().subscriptionId,'role1')]",
        "role2":                 "[guid(resourceGroup().id,subscription().subscriptionId,'role2')]",
        "role3":                 "[guid(resourceGroup().id,subscription().subscriptionId,'role3')]",
        "customData":            "[concat('{\"AdminPassword\":\"', parameters('ftdAdminUserPassword'), '\",\"Hostname\": \"cisco-ftdv\", \"FmcIp\": \"DONTRESOLVE\", \"FmcRegKey\":\"1234\", \"FmcNatId\":\"5678\", \"Cluster\":{\"CclSubnetRange\": \"', parameters('cclSubnetStartAddr'), ' ', parameters('cclSubnetEndAddr'), '\",\"ClusterGroupName\":\"', parameters('clusterGroupName'), '\"}}')]"
    },
    "resources": [
        {
            "apiVersion": "2021-08-01",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[variables('mgmtSecGrp')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "SSH-Rule",
                        "properties": {
                            "description": "Allow SSH",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "22",
                            "sourceAddressPrefix": "Internet",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "HTTPS-Rule",
                        "properties": {
                            "description": "Allow tcp 443",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "443",
                            "sourceAddressPrefix": "Internet",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 101,
                            "direction": "Inbound"
                        }
                    },
                    {
                        "name": "Fmc-Port",
                        "properties": {
                            "description": "Port 8305 for FMC communication",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8305",
                            "sourceAddressPrefix": "Internet",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 102,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2021-08-01",
            "name": "[variables('dataSecGrp')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "securityRules": [
                    {
                        "name": "Allow-All",
                        "properties": {
                            "description": "Allow SSH",
                            "protocol": "Tcp",
                            "sourcePortRange": "*",
                            "destinationPortRange": "*",
                            "sourceAddressPrefix": "Internet",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 100,
                            "direction": "Inbound"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-09-01",
            "name": "[variables('storageAccountName')]",
            "location": "[resourceGroup().location]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_LRS"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
            "apiVersion": "2021-09-01",
            "name": "[concat(variables('storageAccountName'), '/default/', variables('queuename'))]",
            "properties": {
                "metadata": {}
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
            "apiVersion": "2021-09-01",
            "name": "[concat(variables('storageAccountName'), '/default/', 'outqueue')]",
            "properties": {
                "metadata": {}
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02",
            "name": "[variables('appInsightsName')]",
            "kind": "web",
            "location": "[resourceGroup().location]",
            "tags": {
                "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', variables('functionAppName'))]": "Resource"
            },
            "properties": {
                "Application_Type": "web",
                "ApplicationId": "[variables('appInsightsName')]"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2021-03-01",
            "name": "[variables('functionAppName')]",
            "location": "[resourceGroup().location]",
            "kind": "functionapp,linux",
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            ],
            "properties": {
                "enabled": true,
                "siteConfig": {
                    "linuxFxVersion": "PYTHON|3.9",
                    "appSettings": [
                        {
                            "name": "AzureWebJobsStorage",
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountid'),'2019-06-01').keys[0].value)]"
                        },
                        {
                            "name": "AzureWebJobsDashboard",
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountid'),'2019-06-01').keys[0].value)]"
                        },
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                            "value": "[reference(resourceId('microsoft.insights/components/', variables('appInsightsName')), '2015-05-01').InstrumentationKey]"
                        },
                        {
                            "name": "FUNCTIONS_WORKER_RUNTIME",
                            "value": "[variables('functionWorkerRuntime')]"
                        },
                        {
                            "name": "FUNCTIONS_EXTENSION_VERSION",
                            "value": "~4"
                        },
                        {
                            "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                            "value": "true"
                        },
                        {
                            "name": "ENABLE_ORYX_BUILD",
                            "value": "true"
                        },
                        {
                           "name": "RESOURCE_PREFIX",
                           "value": "[parameters('resourceNamePrefix')]"
                        },
                        {
                            "name": "ANY_IPV4_NAME",
                            "value": "[concat(parameters('resourceNamePrefix'),'-anyipv4')]"
                        },
                        {
                            "name": "AZURE_UTILITY_IP",
                            "value": "168.63.129.16"
                        },
                        {
                            "name": "AZURE_UTILITY_IP_NAME",
                            "value": "azure-utility-ip"
                        },
                        {
                            "name": "FMC_DOMAIN_UUID",
                            "value": "e276abec-e0f2-11e3-8169-6d9ed49b625f"
                        },
                        {
                            "name": "FMC_IP",
                            "value": "[parameters('fmcIpAddress')]"
                        },
                        {
                            "name": "FMC_PASSWORD",
                            "value": "[parameters('fmcPassword')]"
                        },
                        {
                            "name": "FMC_USERNAME",
                            "value": "[parameters('fmcUserName')]"
                        },
                        {
                            "name": "FTD_PASSWORD",
                            "value": "[parameters('ftdAdminUserPassword')]"
                        },
                        {
                            "name": "FTD_USERNAME",
                            "value":"admin"
                        },
                        {
                            "name": "IN_NET_GW",
                            "value": "[parameters('insideNetworkGatewayIp')]"
                        },
                        {
                            "name": "INSIDE_GW_OBJ_NAME",
                            "value": "[concat(parameters('resourceNamePrefix'),'-inside-gw')]"
                        },
                        {
                            "name": "OUTSIDE_NIC_INTERFACE",
                            "value": "GigabitEthernet0/1"
                        },
                        {
                            "name": "INSIDE_NIC_NAME",
                            "value": "asminside"
                        },
                        {
                            "name": "INSIDE_ZONE",
                            "value": "[parameters('insideZoneName')]"
                        },
                        {
                            "name": "OUT_NET_GW",
                            "value": "[parameters('outsideNetworkGatewayIp')]"
                        },
                        {
                            "name": "OUTSIDE_GW_OBJ_NAME",
                            "value": "[concat(parameters('resourceNamePrefix'),'-outside-gw')]"
                        },
                        {
                            "name": "INSIDE_NIC_INTERFACE",
                            "value": "GigabitEthernet0/0"
                        },
                        {
                            "name": "OUTSIDE_NIC_NAME",
                            "value": "asmoutside"
                        },
                        {
                            "name": "OUTSIDE_ZONE",
                            "value": "[parameters('outsideZoneName')]"
                        },
                        {
                            "name": "FTD_COUNT",
                            "value": "[parameters('ftdvClusterNodeCount')]"
                        },
                        {
                            "name": "MNGT_IP_CONFIG_NAME",
                            "value": "myIpConfig"
                        },
                        {
                            "name": "MNGT_NET_INTERFACE_NAME",
                            "value": "mgmtNic"
                        },
                        {
                            "name": "MNGT_PUBLIC_IP_NAME",
                            "value": "mgmtPublicIP"
                        },
                        {
                            "name": "NAT_ID",
                            "value": "5678"
                        },
                        {
                            "name": "NETWORK_CIDR",
                            "value": "[parameters('virtualNetworkCidr')]"
                        },
                        {
                            "name": "NETWORK_NAME",
                            "value": "[concat(parameters('resourceNamePrefix'),'-vnet')]"
                        },
                        {
                            "name": "POLICY_NAME",
                            "value": "[parameters('policyName')]"
                        },
                        {
                            "name": "REG_KEY",
                            "value": "1234"
                        },
                        {
                            "name": "RESOURCE_GROUP_NAME",
                            "value": "[resourceGroup().name]"
                        },
                        {
                            "name": "SUBSCRIPTION_ID",
                            "value": "[subscription().subscriptionId]"
                        },
                        {
                            "name": "VMSS_NAME",
                            "value": "[variables('vmssName')]"
                        },
                        {
                            "name": "LICENSE_CAPABILITY",
                            "value": "[parameters('licenseCapability')]"
                        }
                    ]
                },
                "reserved": true
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2021-08-01",
            "name": "[variables('elbPublicIpName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                    "domainNameLabel": "[variables('elbPublicIpName')]"
                },
                "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutes')]"
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2021-08-01",
            "name": "[variables('elbName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('elbPublicIpName'))]"
            ],
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses/', variables('elbPublicIpName'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "backendPool"
                    }
                ],
                "loadBalancingRules": [
                    {
                        "properties": {
                            "frontendIPConfiguration": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('elbName')), '/frontendIpConfigurations/LoadBalancerFrontend')]"
                            },
                            "backendAddressPool": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('elbName')), '/backendAddressPools/BackendPool')]"
                            },
                            "probe": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('elbName')), '/probes/lbprobe')]"
                            },
                            "protocol": "TCP",
                            "frontendPort": "80",
                            "backendPort": "80",
                            "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutes')]"
                        },
                        "Name": "lbrule"
                    }
                ],
                "probes": [
                    {
                        "properties": {
                            "protocol": "Tcp",
                            "port": 22,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        },
                        "name": "lbprobe"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2021-08-01",
            "name": "[variables('ilbName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "properties": {
                            "subnet": {
                                "id": "[variables('insideSubnetId')]"
                            },
                            "privateIPAddress": "[parameters('internalLbIP')]",
                            "privateIPAllocationMethod": "Static"
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "backendPool"
                    }
                ],
                "loadBalancingRules": [
                    {
                        "properties": {
                            "frontendIPConfiguration": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('ilbName')), '/frontendIpConfigurations/LoadBalancerFrontend')]"
                            },
                            "backendAddressPool": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('ilbName')), '/backendAddressPools/BackendPool')]"
                            },
                            "probe": {
                                "Id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('ilbName')), '/probes/lbprobe')]"
                            },
                            "protocol": "All",
                            "frontendPort": 0,
                            "backendPort": 0,
                            "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutes')]"
                        },
                        "Name": "lbrule"
                    }
                ],
                "probes": [
                    {
                        "properties": {
                            "protocol": "Tcp",
                            "port": 22,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        },
                        "name": "lbprobe"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.EventGrid/systemTopics",
            "apiVersion": "2020-10-15-preview",
            "name": "[variables('systopicname')]",
            "location": "global",
            "identity":{
                "type": "SystemAssigned"
            },
            "properties": {
                "source": "[resourceGroup().id]",
                "topicType": "Microsoft.Resources.ResourceGroups"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2021-11-01",
            "name": "[variables('vmssName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[concat('Microsoft.Network/loadBalancers/', variables('elbName'))]",
                "[concat('Microsoft.Network/loadBalancers/', variables('ilbName'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('mgmtSecGrp'))]",
                "[concat('Microsoft.Network/networkSecurityGroups/', variables('dataSecGrp'))]",
                "[concat('Microsoft.Web/sites/', variables('functionAppName'))]",
                "[concat('Microsoft.EventGrid/systemTopics/',variables('systopicname'))]",
                "[resourceID('Microsoft.Storage/storageAccounts/queueServices/queues', variables('storageAccountName'), 'default', variables('queuename'))]",
                "[resourceID('Microsoft.Storage/storageAccounts/queueServices/queues', variables('storageAccountName'), 'default', 'outqueue')]"
            ],
            "sku": {
                "name": "[parameters('vmSize')]",
                "capacity": "[parameters('ftdvClusterNodeCount')]"
            },
            "zones": [
                "1",
                "2",
                "3"
            ],
            "properties": {
                "singlePlacementGroup": false,
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "imageReference": {
                            "id": "[parameters('imageId')]"
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "[variables('vmssName')]",
                        "adminUsername": "[parameters('ftdVmManagementUserName')]",
                        "adminPassword": "[parameters('ftdVmManagementUserPassword')]",
                        "customData": "[base64(variables('customData'))]"
                    },
                    "diagnosticsProfile": {
                        "bootDiagnostics": {
                            "enabled": true,
                            "storageUri": "[concat('https://',variables('storageAccountName'),'.blob.core.windows.net')]"
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[variables('vmssVmMgmtNicName')]",
                                "properties": {
                                    "primary": true,
                                    "networkSecurityGroup": {
                                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('mgmtSecGrp'))]"
                                    },
                                    "ipConfigurations": [
                                        {
                                            "name": "myIpConfig",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('mgmtSubnetId')]"
                                                },
                                                "publicipaddressconfiguration": {
                                                    "name": "mgmtPublicIP",
                                                    "properties": {
                                                        "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutes')]"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "[variables('vmssVmDiagNicName')]",
                                "properties": {
                                    "primary": false,
                                    "ipConfigurations": [
                                        {
                                            "name": "myIpConfig",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('diagSubnetId')]"
                                                }
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "[variables('vmssVmInsideNicName')]",
                                "properties": {
                                    "primary": false,
                                    "enableIPForwarding": true,
                                    "networkSecurityGroup": {
                                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('dataSecGrp'))]"
                                    },
                                    "ipConfigurations": [
                                        {
                                            "name": "myIpConfig",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('insideSubnetId')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat( variables('ilbId'), '/backendAddressPools/backendPool')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "[variables('vmssVmOutsideNicName')]",
                                "properties": {
                                    "primary": false,
                                    "enableIPForwarding": true,
            					    "networkSecurityGroup": {
                                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('dataSecGrp'))]"
                                    },
                                    "ipConfigurations": [
                                        {
                                            "name": "myIpConfig",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('outsideSubnetId')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat( variables('elbId'), '/backendAddressPools/backendPool')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                "name": "[variables('vmssVmCclNicName')]",
                                "properties": {
                                    "primary": false,
                                    "ipConfigurations": [
                                        {
                                            "name": "myIpConfig",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[variables('cclSubnetId')]"
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            }
        },
        {
           "type": "Microsoft.Insights/autoscaleSettings",
           "apiVersion": "2015-04-01",
           "name": "instance count limit",
           "location": "[resourceGroup().location]",
           "dependsOn": [
               "[concat('Microsoft.Compute/virtualMachineScaleSets/', variables('vmssName'))]"
           ],
           "properties": {
               "name": "instance count limit",
               "targetResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', variables('vmssName'))]",
               "enabled": true,
               "profiles": [
                   {
                       "name": "Fix instance count",
                       "capacity": {
                           "minimum": "[parameters('ftdvClusterNodeCount')]",
                           "maximum": "[parameters('ftdvClusterNodeCount')]",
                           "default": "[parameters('ftdvClusterNodeCount')]"
                       },
                       "rules": []
                   }
               ]
           }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2015-07-01",
            "name": "[variables('role1')]",
            "dependsOn": [
                "[resourceID('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2016-03-01', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-01-01-preview",
            "name": "[variables('role2')]",
            "dependsOn": [
                "[resourceID('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2016-03-01', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-01-01-preview",
            "name": "[variables('role3')]",
            "dependsOn": [
                "[resourceID('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '974c5e8b-45b9-4653-ba55-5f855dd0fb88')]",
                "principalId": "[reference(resourceId('Microsoft.EventGrid/systemTopics', variables('systopicname')), '2020-10-15-preview', 'Full').identity.principalId]"
            }
        },
        {
            "type": "Microsoft.EventGrid/systemTopics/eventSubscriptions",
            "apiVersion": "2021-12-01",
            "name": "[concat(variables('systopicname'), '/', variables('esubname'))]",
            "dependsOn":[
                "[resourceID('Microsoft.Authorization/roleAssignments',variables('role3'))]"
            ],
            "properties": {
                "filter": {
                    "includedEventTypes": [
                        "Microsoft.Resources.ResourceActionSuccess"
                    ],
                    "advancedFilters": [],
                    "enableAdvancedFilteringOnArrays": true
                },
                "labels": [],
                "eventDeliverySchema": "EventGridSchema",
                "destination": {
                    "endpointType": "StorageQueue",
                    "properties": {
                        "resourceId": "[resourceId('Microsoft.Storage/storageAccounts',variables('storageAccountName'))]",
                        "queueName": "[variables('queuename')]",
                        "queueMessageTimeToLiveInSeconds": 604800
                    }
                }
            }
        }
    ]
}